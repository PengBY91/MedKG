version: "3.8"

name: medical-governance

services:
  neo4j:
    # Use OpenSPG standard image to support multi-db or specific plugins
    image: spg-registry.cn-hangzhou.cr.aliyuncs.com/spg/openspg-neo4j:latest
    container_name: medical_neo4j
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - neo4j-data:/data

  postgres:
    image: postgres:16
    container_name: medical_postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=medical_user
      - POSTGRES_PASSWORD=medical_pass
      - POSTGRES_DB=medical_governance
    volumes:
      - postgres-data:/var/lib/postgresql/data

  milvus:
    image: milvusdb/milvus:v2.3.0
    container_name: medical_milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    depends_on:
      - etcd
      - minio
    volumes:
      - milvus-data:/var/lib/milvus

  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: medical_etcd
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - etcd-data:/etcd

  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    container_name: medical_minio
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio-data:/minio_data
    command: minio server /minio_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # OpenSPG Services
  openspg-mysql:
    restart: always
    image: spg-registry.cn-hangzhou.cr.aliyuncs.com/spg/openspg-mysql:latest
    container_name: medical_openspg_mysql
    environment:
      TZ: Asia/Shanghai
      LANG: C.UTF-8
      MYSQL_ROOT_PASSWORD: openspg
      MYSQL_DATABASE: openspg
    ports:
      - "3307:3306" # Avoid conflict with host mysql if any
    command:
      [
        "--character-set-server=utf8mb4",
        "--collation-server=utf8mb4_general_ci",
      ]
    volumes:
      - openspg-mysql-data:/var/lib/mysql

  openspg-server:
    restart: always
    image: spg-registry.cn-hangzhou.cr.aliyuncs.com/spg/openspg-server:latest
    container_name: medical_openspg_server
    ports:
      - "8887:8887"
    depends_on:
      - openspg-mysql
      - neo4j
    environment:
      TZ: Asia/Shanghai
      LANG: C.UTF-8
    command:
      [
        "java",
        "-Dfile.encoding=UTF-8",
        "-Xms1024m",
        "-Xmx2048m",
        "-jar",
        "arks-sofaboot-0.0.1-SNAPSHOT-executable.jar",
        "--server.repository.impl.jdbc.host=openspg-mysql",
        "--server.repository.impl.jdbc.password=openspg",
        "--builder.model.execute.num=10",
        "--cloudext.graphstore.url=neo4j://neo4j:7687?user=neo4j&password=password&database=neo4j",
        "--cloudext.searchengine.url=neo4j://neo4j:7687?user=neo4j&password=password&database=neo4j",
      ]

volumes:
  neo4j-data:
  postgres-data:
  milvus-data:
  etcd-data:
  minio-data:
  openspg-mysql-data:
