# 多轮对话功能 - 快速开始

## 🚀 功能亮点

✅ **智能上下文理解** - 自动识别指代词，理解对话上下文  
✅ **对话历史管理** - 保存、查看、切换、删除对话  
✅ **可视化推理链路** - 完整展示 AI 思考过程  
✅ **对话持久化** - 历史对话永久保存  
✅ **多设备同步** - 基于用户账号的对话管理  

---

## 📋 前置要求

1. 后端服务已启动（端口 8001）
2. 前端服务已启动（端口 3000）
3. 已登录用户账号

---

## 🎯 快速体验

### 1. 开始第一个对话

访问：`http://localhost:3000/explanation`

**输入第一个问题**:
```
门诊透析费用有限额吗？
```

**AI 回复**:
```
【图谱协同结论】
根据《基本医疗保险门诊特殊疾病管理规定（2024版）》...
每日治疗费用限额为420元...
```

### 2. 继续对话（体验上下文理解）

**直接追问**:
```
那糖尿病呢？
```

**系统自动理解为**:
```
💡 理解为：糖尿病门诊费用有限额吗？
```

**AI 回复**:
```
根据政策库检索，糖尿病作为门诊特殊疾病...
```

### 3. 查看对话历史

- 左侧栏自动显示对话列表
- 对话标题：从第一个问题自动生成
- 显示消息数量和更新时间

### 4. 切换对话

- 点击左侧栏任意历史对话
- 自动加载完整对话历史
- 继续在该对话中提问

### 5. 管理对话

**重命名**:
1. 点击对话右侧"..."按钮
2. 选择"重命名"
3. 输入新标题

**删除**:
1. 点击对话右侧"..."按钮
2. 选择"删除"
3. 确认删除

---

## 💡 使用技巧

### 提问技巧

#### ✅ 推荐做法

**第一轮 - 完整描述**:
```
门诊透析费用有限额吗？
```

**第二轮 - 简短追问**:
```
那糖尿病呢？           // ✅ 系统自动理解
超限了怎么办？         // ✅ 系统知道指"透析费用超限"
有哪些例外情况？       // ✅ 系统知道指"透析费用限额"
```

#### ❌ 避免做法

```
它                    // ❌ 太模糊
这个                  // ❌ 指代不清
上面说的那个           // ❌ 可能理解错误
```

### 对话管理技巧

1. **按主题分对话**
   - 透析政策 → 一个对话
   - 糖尿病政策 → 另一个对话
   - 便于后续查找

2. **定期清理**
   - 删除测试对话
   - 清理无用对话
   - 保持列表整洁

3. **善用重命名**
   - 给对话起有意义的名字
   - 如："2024年透析政策咨询"

---

## 🎨 界面功能说明

### 对话历史侧边栏

```
┌─────────────────────┐
│ 对话历史      [+] [<] │  ← [+]新建 [<]折叠
├─────────────────────┤
│ 📝 门诊透析费用...   │  ← 对话标题
│    8条消息 2小时前    │  ← 消息数 + 时间
│    [...]             │  ← 操作菜单
├─────────────────────┤
│ 📝 糖尿病政策...     │
│    5条消息 1天前      │
└─────────────────────┘
```

### 消息气泡

**用户消息**（蓝色，右侧）:
```
┌──────────────────┐
│  门诊透析费用有   │
│  限额吗？        │
└──────────────────┘
        [头像] 👤
```

**AI 回复**（灰色，左侧）:
```
[头像] 🤖
┌────────────────────────┐
│ 💡 理解为：...          │  ← 上下文提示
│                         │
│ 根据政策...             │  ← 回答内容
│                         │
│ [📊 推理链路]           │  ← 可展开查看
│ [📄 依据条文]           │  ← 引用来源
└────────────────────────┘
```

### 推理链路

点击"推理链路"展开：

```
✅ 0. Conversation Context
   处理 2 轮对话历史，补全指代

✅ 1. Query Understanding  
   识别实体: 1个, 查询改写: 否
   
✅ 2. Multi-channel Retrieval
   检索到 6 条政策规则
   
✅ 3. Result Ranking
   使用 MMR 重排序，选出 Top-5
   
✅ 4. KAG Logic Reasoning
   KAG 成功执行逻辑推理
   
✅ 5. Terminology Standardization
   标准化 1 个医学术语
   
✅ 6. Knowledge Fusion
   多源知识融合生成最终答案
```

---

## 🔧 故障排除

### 问题 1：看不到对话历史

**原因**: 未登录或登录过期

**解决**:
```bash
1. 检查是否已登录
2. 重新登录
3. 刷新页面
```

### 问题 2：对话无法保存

**原因**: 后端服务未启动或API异常

**解决**:
```bash
# 检查后端服务
./start.sh status

# 重启后端
./start.sh restart

# 查看日志
./start.sh logs backend
```

### 问题 3：上下文理解错误

**示例**: 
```
用户: "那高血压呢？"
系统: 仍然回答透析相关内容
```

**原因**: 当前指代识别基于简单规则

**解决**:
- 提问时尽量完整描述
- 或明确提到主题："高血压的费用限额"

### 问题 4：对话列表加载慢

**原因**: 对话数量过多

**解决**:
```
1. 清理旧对话
2. 删除测试对话
3. 点击底部"清空所有对话"
```

---

## 📊 API 使用示例

### 创建新对话并提问

```bash
# 1. 发送第一个问题（自动创建对话）
curl -X POST "http://localhost:8000/api/v1/explanation/query" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "门诊透析费用有限额吗？",
    "use_history": true
  }'

# 响应示例
{
  "session_id": "conv_abc123def456",  // 保存此ID用于后续对话
  "answer": "根据政策...",
  "sources": [...],
  "reasoning_trace": [...],
  "metadata": {
    "has_conversation_context": false,
    "pipeline_version": "enhanced-v2-multiturn"
  }
}
```

### 继续对话

```bash
# 2. 使用相同的 session_id 继续提问
curl -X POST "http://localhost:8000/api/v1/explanation/query" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "那糖尿病呢？",
    "session_id": "conv_abc123def456",
    "use_history": true
  }'

# 响应示例
{
  "session_id": "conv_abc123def456",
  "contextualized_question": "糖尿病门诊费用有限额吗？",  // 上下文化
  "answer": "糖尿病作为门诊特殊疾病...",
  "metadata": {
    "has_conversation_context": true,  // 注意这里变为true
    ...
  }
}
```

### 获取对话历史

```bash
# 3. 获取所有对话列表
curl "http://localhost:8000/api/v1/conversations/conversations?limit=10" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 响应示例
{
  "success": true,
  "data": {
    "items": [
      {
        "session_id": "conv_abc123def456",
        "title": "门诊透析费用有限额吗？...",
        "message_count": 4,
        "created_at": "2024-12-28T10:30:00",
        "updated_at": "2024-12-28T10:35:00",
        "summary": "门诊透析费用有限额吗？... (4 条消息)"
      }
    ],
    "total": 1
  }
}
```

### 加载特定对话

```bash
# 4. 获取对话的所有消息
curl "http://localhost:8000/api/v1/conversations/conversations/conv_abc123def456/messages" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 响应示例
{
  "success": true,
  "data": {
    "session_id": "conv_abc123def456",
    "messages": [
      {
        "role": "user",
        "content": "门诊透析费用有限额吗？",
        "timestamp": "2024-12-28T10:30:00",
        "metadata": {}
      },
      {
        "role": "ai",
        "content": "根据政策...",
        "timestamp": "2024-12-28T10:30:05",
        "metadata": {
          "sources": [...],
          "reasoning_trace": [...]
        }
      },
      ...
    ],
    "total": 4
  }
}
```

---

## 🎓 最佳实践总结

### ✅ 推荐做法

1. **第一轮完整提问** - 给AI足够的上下文
2. **后续简短追问** - 利用对话历史
3. **按主题分对话** - 方便管理查找
4. **及时重命名** - 使用有意义的标题
5. **定期清理** - 删除无用对话

### ❌ 避免做法

1. ❌ 每个问题都创建新对话
2. ❌ 使用过于模糊的指代词
3. ❌ 跨主题混合提问
4. ❌ 长时间不清理历史
5. ❌ 在错误的对话中继续提问

---

## 📞 需要帮助？

1. **查看完整文档**: `docs/MULTITURN_CONVERSATION.md`
2. **查看优化方案**: `docs/EXPLANATION_QA_OPTIMIZATION.md`
3. **提交Issue**: 或联系开发团队

---

**文档版本**: v1.0  
**更新日期**: 2024-12-28  
**维护者**: MedKG 开发团队

