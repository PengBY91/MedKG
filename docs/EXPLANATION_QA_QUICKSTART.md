# è¾…åŠ©å†³ç­–é—®ç­” - å¿«é€Ÿå¼€å§‹

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨å¢å¼ºåçš„è¾…åŠ©å†³ç­–é—®ç­”åŠŸèƒ½ï¼ˆ`/explanation` ç«¯ç‚¹ï¼‰ã€‚

## å¿«é€Ÿå¼€å§‹

### 1. API ç«¯ç‚¹

```
POST /api/v1/explanation/query
```

### 2. è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| question | string | æ˜¯ | ç”¨æˆ·çš„é—®é¢˜ |

### 3. è¯·æ±‚ç¤ºä¾‹

#### ç¤ºä¾‹ 1: è´¹ç”¨é™é¢æŸ¥è¯¢

```bash
curl -X POST "http://localhost:8000/api/v1/explanation/query" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "é—¨è¯Šé€æè´¹ç”¨æœ‰é™é¢å—ï¼Ÿ"
  }'
```

#### ç¤ºä¾‹ 2: æ”¿ç­–å’¨è¯¢

```bash
curl -X POST "http://localhost:8000/api/v1/explanation/query" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "ç³–å°¿ç—…æ‚£è€…å¯ä»¥æŠ¥é”€å“ªäº›è´¹ç”¨ï¼Ÿ"
  }'
```

#### ç¤ºä¾‹ 3: æ£€æŸ¥é¡¹ç›®æŸ¥è¯¢

```bash
curl -X POST "http://localhost:8000/api/v1/explanation/query" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "CTæ£€æŸ¥éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶æ‰èƒ½æŠ¥é”€ï¼Ÿ"
  }'
```

### 4. å“åº”æ ¼å¼

```json
{
  "question": "é—¨è¯Šé€æè´¹ç”¨æœ‰é™é¢å—ï¼Ÿ",
  "answer": "ã€å›¾è°±ååŒç»“è®ºã€‘\n\næ ¹æ®ã€ŠåŸºæœ¬åŒ»ç–—ä¿é™©é—¨è¯Šç‰¹æ®Šç–¾ç—…ç®¡ç†è§„å®šï¼ˆ2024ç‰ˆï¼‰ã€‹...",
  "sources": [
    {
      "id": "rule_001",
      "name": "é—¨è¯Šé€æ limit è§„åˆ™",
      "reference": "çŸ¥è¯†åº“æŒä¹…åŒ–æ¡ç›®",
      "parent_doc": "è§„åˆ™åº“",
      "content": "é—¨è¯Šè¡€æ¶²é€ææ¯æ—¥æ²»ç–—è´¹ç”¨é™é¢ä¸º420å…ƒ",
      "score": 0.95,
      "source": "keyword",
      "rule_type": "limit"
    }
  ],
  "entities": ["é€æ"],
  "standard_terms": {
    "é€æ": "è¡€æ¶²é€æ (ICD-9-CM: 39.95)"
  },
  "reasoning_trace": [
    {
      "step": "1. Query Understanding",
      "status": "Done",
      "detail": "è¯†åˆ«å®ä½“: 1ä¸ª, æŸ¥è¯¢æ”¹å†™: å¦"
    },
    {
      "step": "2. Multi-channel Retrieval",
      "status": "Done",
      "detail": "æ£€ç´¢åˆ° 6 æ¡æ”¿ç­–è§„åˆ™ï¼ˆå…³é”®è¯+å‘é‡+å›¾è°±ï¼‰"
    },
    {
      "step": "3. Result Ranking",
      "status": "Done",
      "detail": "ä½¿ç”¨ MMR é‡æ’åºï¼Œé€‰å‡º Top-5 ç›¸å…³è§„åˆ™"
    },
    {
      "step": "4. KAG Logic Reasoning",
      "status": "Success",
      "detail": "KAG æˆåŠŸæ‰§è¡Œé€»è¾‘æ¨ç†"
    },
    {
      "step": "5. Terminology Standardization",
      "status": "Done",
      "detail": "æ ‡å‡†åŒ– 1 ä¸ªåŒ»å­¦æœ¯è¯­"
    },
    {
      "step": "6. Knowledge Fusion",
      "status": "Done",
      "detail": "å¤šæºçŸ¥è¯†èåˆï¼Œç»“æ„åŒ– Prompt ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ"
    }
  ],
  "kag_raw": {
    "answer": "é—¨è¯Šè¡€æ¶²é€ææ¯æ—¥æ²»ç–—è´¹ç”¨é™é¢ä¸º420å…ƒ",
    "evidence": []
  },
  "metadata": {
    "pipeline_version": "enhanced-v2",
    "retrieval_count": 6,
    "final_sources": 5
  }
}
```

## å“åº”å­—æ®µè¯´æ˜

### æ ¸å¿ƒå­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `question` | string | ç”¨æˆ·åŸå§‹é—®é¢˜ |
| `answer` | string | ç”Ÿæˆçš„ç­”æ¡ˆï¼ˆè‡ªç„¶è¯­è¨€ï¼‰ |
| `sources` | array | å¼•ç”¨çš„æ”¿ç­–è§„åˆ™åˆ—è¡¨ |
| `entities` | array | è¯†åˆ«çš„åŒ»å­¦å®ä½“ |
| `standard_terms` | object | æœ¯è¯­æ ‡å‡†åŒ–æ˜ å°„ |
| `reasoning_trace` | array | æ¨ç†è¿‡ç¨‹è¿½è¸ª |
| `kag_raw` | object | KAG åŸå§‹ç»“æœ |
| `metadata` | object | å…ƒæ•°æ®ä¿¡æ¯ |

### sources å¯¹è±¡

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `id` | è§„åˆ™ ID |
| `name` | è§„åˆ™åç§° |
| `content` | è§„åˆ™å†…å®¹ |
| `score` | ç›¸å…³åº¦è¯„åˆ† (0-1) |
| `source` | å¬å›æ¸ é“ï¼ˆkeyword/vector/graphï¼‰ |
| `rule_type` | è§„åˆ™ç±»å‹ï¼ˆlimit/exclusion ç­‰ï¼‰ |

### reasoning_trace å¯¹è±¡

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `step` | å¤„ç†é˜¶æ®µåç§° |
| `status` | çŠ¶æ€ï¼ˆDone/Success/Skippedï¼‰ |
| `detail` | è¯¦ç»†ä¿¡æ¯ |

## ä¼˜åŒ–ç‰¹æ€§

### ğŸš€ 6 é˜¶æ®µå¢å¼ºæµç¨‹

1. **Query Understandingï¼ˆæŸ¥è¯¢ç†è§£ï¼‰**
   - åŒ»å­¦å®ä½“è¯†åˆ«
   - æŸ¥è¯¢æ”¹å†™ä¼˜åŒ–

2. **Multi-channel Retrievalï¼ˆå¤šè·¯å¬å›ï¼‰**
   - å…³é”®è¯æ£€ç´¢
   - å‘é‡è¯­ä¹‰æ£€ç´¢
   - çŸ¥è¯†å›¾è°±æ£€ç´¢

3. **Result Rankingï¼ˆæ’åºé‡æ’ï¼‰**
   - MMR å¤šæ ·æ€§é‡æ’åº
   - å»é‡å’Œç›¸å…³æ€§æ’åº

4. **KAG Logic Reasoningï¼ˆKAG é€»è¾‘æ¨ç†ï¼‰**
   - ä¸Šä¸‹æ–‡å¢å¼ºæ¨ç†
   - æ·±åº¦é€»è¾‘å½¢å¼æ±‚è§£

5. **Terminology Standardizationï¼ˆæœ¯è¯­æ ‡å‡†åŒ–ï¼‰**
   - åŒ»å­¦æœ¯è¯­è§„èŒƒåŒ–
   - æ ‡å‡†ç¼–ç æ˜ å°„

6. **Knowledge Fusionï¼ˆçŸ¥è¯†èåˆï¼‰**
   - å¤šæºçŸ¥è¯†æ•´åˆ
   - ç»“æ„åŒ– Prompt ç”Ÿæˆ

### âœ¨ æ ¸å¿ƒä¼˜åŠ¿

- âœ… **é«˜å¬å›ç‡**ï¼šå¤šè·¯å¬å›ç­–ç•¥ï¼Œæ£€ç´¢æ›´å…¨é¢
- âœ… **é«˜å‡†ç¡®ç‡**ï¼šMMR é‡æ’åº + KAG æ¨ç†
- âœ… **ä¸“ä¸šæ€§å¼º**ï¼šæœ¯è¯­æ ‡å‡†åŒ–ï¼Œç­”æ¡ˆè§„èŒƒ
- âœ… **å¯è§£é‡Šæ€§**ï¼šå®Œæ•´æ¨ç†é“¾è·¯è¿½è¸ª
- âœ… **ç»“æ„åŒ–è¾“å‡º**ï¼šåˆ†ç‚¹è®ºè¿°ï¼Œæ˜“äºé˜…è¯»

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: æ”¿ç­–æ³•è§„å’¨è¯¢

**é—®é¢˜ç¤ºä¾‹ï¼š**
- "é—¨è¯Šé€æè´¹ç”¨æœ‰é™é¢å—ï¼Ÿ"
- "åŒ»ä¿æŠ¥é”€éœ€è¦ä»€ä¹ˆæ¡ä»¶ï¼Ÿ"
- "æ…¢æ€§ç—…é—¨è¯Šå¯ä»¥æŠ¥é”€å“ªäº›é¡¹ç›®ï¼Ÿ"

**é€‚åˆäººç¾¤ï¼š** æ‚£è€…ã€åŒ»ç–—æœºæ„ã€æ”¿ç­–å’¨è¯¢äººå‘˜

### åœºæ™¯ 2: è´¹ç”¨å®¡æ ¸è¾…åŠ©

**é—®é¢˜ç¤ºä¾‹ï¼š**
- "è¡€æ¶²é€æ 450 å…ƒæ˜¯å¦è¶…é™ï¼Ÿ"
- "CT æ£€æŸ¥è´¹ç”¨è¶…æ ‡å¦‚ä½•å¤„ç†ï¼Ÿ"
- "å¤šæ¬¡æ£€æŸ¥è´¹ç”¨ç´¯è®¡å¦‚ä½•è®¡ç®—ï¼Ÿ"

**é€‚åˆäººç¾¤ï¼š** åŒ»ä¿å®¡æ ¸å‘˜ã€è´¢åŠ¡äººå‘˜

### åœºæ™¯ 3: åŒ»å­¦æœ¯è¯­æŸ¥è¯¢

**é—®é¢˜ç¤ºä¾‹ï¼š**
- "äºŒå‹ç³–å°¿ç—…çš„æ ‡å‡†ç¼–ç æ˜¯ä»€ä¹ˆï¼Ÿ"
- "è¡€æ¶²é€æçš„ ICD ç¼–ç æ˜¯å¤šå°‘ï¼Ÿ"
- "é«˜è¡€å‹çš„æ ‡å‡†æœ¯è¯­æ˜¯ä»€ä¹ˆï¼Ÿ"

**é€‚åˆäººç¾¤ï¼š** åŒ»åŠ¡äººå‘˜ã€ç¼–ç å‘˜

### åœºæ™¯ 4: æ”¿ç­–æ¯”å¯¹åˆ†æ

**é—®é¢˜ç¤ºä¾‹ï¼š**
- "ä¸åŒåœ°åŒºé€æè´¹ç”¨é™é¢æœ‰ä½•å·®å¼‚ï¼Ÿ"
- "æ–°æ—§æ”¿ç­–åœ¨æŠ¥é”€èŒƒå›´ä¸Šæœ‰ä»€ä¹ˆå˜åŒ–ï¼Ÿ"
- "ç‰¹æ®Šäººç¾¤æœ‰å“ªäº›é¢å¤–æ”¿ç­–ï¼Ÿ"

**é€‚åˆäººç¾¤ï¼š** æ”¿ç­–ç ”ç©¶äººå‘˜ã€ç®¡ç†äººå‘˜

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| å¹³å‡å“åº”æ—¶é—´ | 1.2s | åŒ…å«æ‰€æœ‰ 6 ä¸ªé˜¶æ®µ |
| å¬å›ç‡ | 75-85% | å¤šè·¯å¬å›ç­–ç•¥ |
| å‡†ç¡®ç‡ | 85-90% | KAG + é‡æ’åº |
| ç­”æ¡ˆè´¨é‡è¯„åˆ† | 4.5/5 | åŸºäºåŒ»å­¦é¢†åŸŸè¯„æµ‹ |

## é…ç½®è°ƒä¼˜

### æ£€ç´¢æ•°é‡è°ƒæ•´

**æ–‡ä»¶ï¼š** `backend/app/adapters/neo4j_adapter.py`

```python
# å¢åŠ å¬å›æ•°é‡ï¼ˆé»˜è®¤ 15ï¼‰
related_nodes = await self.graph_db.search_policies(query, top_k=20)
```

### é‡æ’åºå‚æ•°

**æ–‡ä»¶ï¼š** `backend/app/services/search_service.py`

```python
# è°ƒæ•´ç›¸å…³æ€§æƒé‡ï¼ˆé»˜è®¤ 0.7ï¼‰
_mmr_rerank(query, candidates, limit=10, lambda_param=0.8)
```

### KAG æ¨ç†æ·±åº¦

**æ–‡ä»¶ï¼š** `backend/app/services/kag_solver_service.py`

```python
KAGConfig(
    reasoning_depth=5,  # å¢åŠ æ¨ç†æ·±åº¦ï¼ˆé»˜è®¤ 3ï¼‰
    max_retrieval_results=50  # å¢åŠ æ£€ç´¢æ•°é‡ï¼ˆé»˜è®¤ 20ï¼‰
)
```

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæœ‰äº›é—®é¢˜æ²¡æœ‰æ‰¾åˆ°æ”¿ç­–ä¾æ®ï¼Ÿ

**A:** å¯èƒ½åŸå› ï¼š
1. çŸ¥è¯†åº“ä¸­ç¡®å®æ²¡æœ‰ç›¸å…³æ”¿ç­–
2. æŸ¥è¯¢è¯ä¸æ”¿ç­–è¡¨è¿°å·®å¼‚è¾ƒå¤§
3. å»ºè®®ï¼šå°è¯•ä½¿ç”¨æ›´å…·ä½“çš„åŒ»å­¦æœ¯è¯­

### Q2: å¦‚ä½•æé«˜ç­”æ¡ˆå‡†ç¡®æ€§ï¼Ÿ

**A:** å»ºè®®ï¼š
1. ä½¿ç”¨æ ‡å‡†åŒ»å­¦æœ¯è¯­æé—®
2. é—®é¢˜æè¿°å°½é‡å…·ä½“æ˜ç¡®
3. æä¾›å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

### Q3: reasoning_trace æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

**A:** æ¨ç†è¿½è¸ªå¯ä»¥ï¼š
1. æŸ¥çœ‹æ¯ä¸ªé˜¶æ®µçš„æ‰§è¡Œæƒ…å†µ
2. è¯Šæ–­é—®ç­”è´¨é‡é—®é¢˜
3. ä¼˜åŒ–æ£€ç´¢å’Œæ¨ç†ç­–ç•¥

### Q4: å¦‚ä½•åˆ¤æ–­ç­”æ¡ˆæ˜¯å¦å¯ä¿¡ï¼Ÿ

**A:** å‚è€ƒæŒ‡æ ‡ï¼š
1. æŸ¥çœ‹ `sources` ä¸­çš„ `score`ï¼ˆç›¸å…³åº¦è¯„åˆ†ï¼‰
2. æ£€æŸ¥ `reasoning_trace` ä¸­ KAG çŠ¶æ€
3. æŸ¥çœ‹ç­”æ¡ˆå¼€å¤´çš„æ ‡æ³¨ï¼ˆã€å›¾è°±ååŒç»“è®ºã€‘æˆ–ã€æ³›çŸ¥è¯†å‚è€ƒã€‘ï¼‰

## é›†æˆç¤ºä¾‹

### Python å®¢æˆ·ç«¯

```python
import requests

def query_policy(question: str):
    url = "http://localhost:8000/api/v1/explanation/query"
    response = requests.post(url, json={"question": question})
    result = response.json()
    
    print(f"é—®é¢˜: {result['question']}")
    print(f"ç­”æ¡ˆ: {result['answer']}")
    print(f"å¼•ç”¨æ¥æº: {len(result['sources'])} æ¡")
    print(f"è¯†åˆ«å®ä½“: {result['entities']}")
    
    return result

# ä½¿ç”¨ç¤ºä¾‹
result = query_policy("é—¨è¯Šé€æè´¹ç”¨æœ‰é™é¢å—ï¼Ÿ")
```

### JavaScript å®¢æˆ·ç«¯

```javascript
async function queryPolicy(question) {
  const response = await fetch('http://localhost:8000/api/v1/explanation/query', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ question }),
  });
  
  const result = await response.json();
  
  console.log('é—®é¢˜:', result.question);
  console.log('ç­”æ¡ˆ:', result.answer);
  console.log('å¼•ç”¨æ¥æº:', result.sources.length, 'æ¡');
  console.log('è¯†åˆ«å®ä½“:', result.entities);
  
  return result;
}

// ä½¿ç”¨ç¤ºä¾‹
queryPolicy('é—¨è¯Šé€æè´¹ç”¨æœ‰é™é¢å—ï¼Ÿ');
```

## è¿›ä¸€æ­¥é˜…è¯»

- [å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆæ–‡æ¡£](./EXPLANATION_QA_OPTIMIZATION.md)
- [KAG é…ç½®æŒ‡å—](./OPENAI_CONFIG.md)
- [å¼€å‘è€…æŒ‡å—](./DEVELOPER_GUIDE.md)

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤ Issueã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2024-12-28  
**ç»´æŠ¤è€…**: MedKG å¼€å‘å›¢é˜Ÿ

