# æµå¼é—®ç­”åŠŸèƒ½æ’æŸ¥å’Œä¿®å¤æŒ‡å—

## é—®é¢˜ç—‡çŠ¶
1. âŒ å‰ç«¯æ²¡æœ‰çœ‹åˆ°æ€è€ƒè¿‡ç¨‹
2. âŒ ç­”æ¡ˆä¸æ˜¯æµå¼æ˜¾ç¤ºï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨å‡ºç°
3. âŒ æ¨ç†é“¾è·¯æ˜¾ç¤ºåœ¨ç”¨æˆ·é—®é¢˜ä¸‹é¢

## é—®é¢˜åŸå› 

### 1. æµè§ˆå™¨ç¼“å­˜é—®é¢˜
å‰ç«¯ JavaScript æ–‡ä»¶è¢«æµè§ˆå™¨ç¼“å­˜ï¼Œæ–°ä»£ç æ²¡æœ‰ç”Ÿæ•ˆã€‚

### 2. å‰ç«¯å¯èƒ½ä»åœ¨è°ƒç”¨æ—§API
æ—¥å¿—æ˜¾ç¤ºè¯·æ±‚çš„æ˜¯ `/api/v1/explanation/query` è€Œä¸æ˜¯ `/api/v1/explanation/query-stream`

## è§£å†³æ­¥éª¤

### æ­¥éª¤ 1: æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

#### Chrome/Edge
1. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
2. å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®
3. é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"

#### æˆ–è€…ä½¿ç”¨æ— ç—•æ¨¡å¼
- Chrome: Ctrl+Shift+N (Windows) / Cmd+Shift+N (Mac)
- åœ¨æ— ç—•çª—å£ä¸­è®¿é—® http://localhost:3000

### æ­¥éª¤ 2: é‡æ–°æ„å»ºå‰ç«¯

```bash
cd /Users/steve/work/æ™ºèƒ½ä½“å¹³å°/MedKG/frontend

# æ¸…é™¤æ—§çš„æ„å»º
rm -rf dist/
rm -rf node_modules/.vite/

# é‡æ–°æ„å»º
npm run build

# æˆ–è€…é‡å¯å¼€å‘æœåŠ¡å™¨
# å¦‚æœå¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢å®ƒ (Ctrl+C)
npm run dev
```

### æ­¥éª¤ 3: é‡å¯åç«¯æœåŠ¡

```bash
cd /Users/steve/work/æ™ºèƒ½ä½“å¹³å°/MedKG

# é‡å¯åç«¯
# å¦‚æœä½¿ç”¨ Docker
docker-compose restart backend

# æˆ–è€…ç›´æ¥é‡å¯ Python è¿›ç¨‹
pkill -f "uvicorn.*main:app"
cd backend && uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### æ­¥éª¤ 4: éªŒè¯æµå¼ API

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12)ï¼Œç„¶åæé—®ã€‚åº”è¯¥çœ‹åˆ°ï¼š

```javascript
[Metadata]: {session_id: "...", reasoning_trace: [...], sources: [...]}
[Thinking Chunk]: é—®é¢˜
[Thinking Chunk]: ç†è§£
[Thinking Chunk]: ï¼š
...
[Thinking Done] Total thinking: é—®é¢˜ç†è§£ï¼šç”¨æˆ·è¯¢é—®...
[Answer Start]
[Done]: {session_id: "...", full_answer: "...", full_thinking: "..."}
```

å¦‚æœ**æ²¡æœ‰**çœ‹åˆ°è¿™äº›æ—¥å¿—ï¼Œè¯´æ˜ï¼š
- å‰ç«¯ä»åœ¨è°ƒç”¨æ—§API
- æˆ–è€…æµå¼APIè°ƒç”¨å¤±è´¥

### æ­¥éª¤ 5: æ£€æŸ¥ç½‘ç»œè¯·æ±‚

1. æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Network (ç½‘ç»œ)
2. æä¸€ä¸ªé—®é¢˜
3. æŸ¥çœ‹è¯·æ±‚åˆ—è¡¨ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   - âœ… `POST /api/v1/explanation/query-stream`
   - âŒ ä¸åº”è¯¥æ˜¯ `POST /api/v1/explanation/query`

å¦‚æœçœ‹åˆ°çš„æ˜¯æ—§APIï¼Œè¯´æ˜å‰ç«¯ä»£ç æ²¡æœ‰æ›´æ–°ã€‚

## å¿«é€Ÿæµ‹è¯•è„šæœ¬

### æµ‹è¯•åç«¯æµå¼API

```bash
# è·å– token (å¦‚æœéœ€è¦)
TOKEN=$(curl -s -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin123" | jq -r '.access_token')

# æµ‹è¯•æµå¼API
curl -N -X POST http://localhost:8000/api/v1/explanation/query-stream \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "question": "é—¨è¯Šé€æçš„æŠ¥é”€é™é¢æ˜¯å¤šå°‘ï¼Ÿ",
    "session_id": null,
    "use_history": false
  }'
```

åº”è¯¥çœ‹åˆ°æµå¼è¾“å‡ºï¼š
```
data: {"type": "metadata", "data": {...}}

data: {"type": "thinking_start"}

data: {"type": "thinking", "content": "é—®"}

data: {"type": "thinking", "content": "é¢˜"}

...
```

## å¸¸è§é—®é¢˜

### Q1: æ§åˆ¶å°æ²¡æœ‰ä»»ä½•æ—¥å¿—
**A**: è¯´æ˜ `queryPolicyStream` æ²¡æœ‰è¢«è°ƒç”¨ï¼Œæˆ–è€…è°ƒç”¨å¤±è´¥äº†ã€‚
- æ£€æŸ¥æ˜¯å¦æœ‰ JavaScript é”™è¯¯
- æ£€æŸ¥ `api.queryPolicyStream` æ˜¯å¦å­˜åœ¨

### Q2: çœ‹åˆ°æ—¥å¿—ä½†æ²¡æœ‰æ€è€ƒè¿‡ç¨‹
**A**: æ£€æŸ¥ï¼š
1. åç«¯æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `[THINKING]` ç›¸å…³æ—¥å¿—
2. LLM æ˜¯å¦é…ç½®æ­£ç¡®ï¼ˆOPENAI_API_KEYï¼‰
3. æ€è€ƒè¿‡ç¨‹ç”Ÿæˆæ˜¯å¦æŠ¥é”™

### Q3: ç­”æ¡ˆä»ç„¶ä¸€æ¬¡æ€§æ˜¾ç¤º
**A**: å¯èƒ½åŸå› ï¼š
1. å‰ç«¯ä»åœ¨è°ƒç”¨ `/api/v1/explanation/query`
2. æµè§ˆå™¨ç¼“å­˜æœªæ¸…é™¤
3. å‰ç«¯ä»£ç æœªé‡æ–°æ„å»º

### Q4: æ¨ç†é“¾è·¯æ˜¾ç¤ºåœ¨ç”¨æˆ·æ¶ˆæ¯ä¸‹
**A**: å·²ä¿®å¤ï¼Œéœ€è¦æ¸…é™¤ç¼“å­˜åé‡æ–°åŠ è½½ã€‚

## æœ€ç»ˆéªŒè¯

æˆåŠŸååº”è¯¥çœ‹åˆ°ï¼š

### 1. æ§åˆ¶å°æ—¥å¿—
```
[Metadata]: ...
[Thinking Chunk]: ...  (å¤šæ¬¡)
[Thinking Done] Total thinking: ...
[Answer Start]
[Done]: ...
```

### 2. é¡µé¢æ˜¾ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ ç”¨æˆ·                             â”‚
â”‚ é—¨è¯Šé€æçš„æŠ¥é”€é™é¢æ˜¯å¤šå°‘ï¼Ÿ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– AI                               â”‚
â”‚                                     â”‚
â”‚ [ç­”æ¡ˆé€å­—æ˜¾ç¤ºï¼Œæ‰“å­—æœºæ•ˆæœ]          â”‚
â”‚ æ ¹ æ® åŒ» ä¿ æ”¿ ç­– ...              â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€ ğŸ’­ AI æ€è€ƒè¿‡ç¨‹ [ç‚¹å‡»å±•å¼€] â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ [é»˜è®¤æŠ˜å ]                       â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€ ğŸ“Š å›¾è°±ååŒæ¨ç†é“¾è·¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [é»˜è®¤æŠ˜å ]                       â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚ ğŸ“š ä¾æ®æ¡æ–‡ï¼š...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ç½‘ç»œè¯·æ±‚
- Method: POST
- URL: `/api/v1/explanation/query-stream`
- Type: `eventsource` æˆ– `fetch`
- Status: 200 OK

## å¦‚æœè¿˜æ˜¯ä¸è¡Œ

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´æ—¥å¿—
2. Network æ ‡ç­¾ä¸­çš„è¯·æ±‚è¯¦æƒ…ï¼ˆURLã€Headersã€Responseï¼‰
3. åç«¯æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯
4. ä½¿ç”¨çš„æµè§ˆå™¨å’Œç‰ˆæœ¬

## å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨éæµå¼API

å¦‚æœæµå¼APIä¸€ç›´æœ‰é—®é¢˜ï¼Œå¯ä»¥æš‚æ—¶åˆ‡æ¢å›éæµå¼APIï¼š

åœ¨ `frontend/src/views/ExplanationQuery.vue` ä¸­ï¼š

```javascript
// æ³¨é‡Šæ‰æµå¼APIè°ƒç”¨
// await api.queryPolicyStream(...)

// ä½¿ç”¨éæµå¼API
const response = await api.queryPolicy(currentQuestion, sessionId)
const data = response.data

messages.value[aiMsgIdx] = {
  role: 'ai',
  content: data.answer,
  sources: data.sources,
  reasoning_trace: data.reasoning_trace,
  thinking: '', // éæµå¼æ¨¡å¼æ²¡æœ‰æ€è€ƒè¿‡ç¨‹
  loading: false
}
```

ä½†è¿™æ ·å°±æ²¡æœ‰æµå¼æ•ˆæœå’Œæ€è€ƒè¿‡ç¨‹äº†ã€‚

